#include <math.h>
#include <stdint.h>
#include <stdio.h>
#include "tools.h"
#include "constants.h"

const float lp[ORDER + 1] = {0.238053579626575,0.064423148855147,0.0684583456734438,0.0684583456734438,0.0644231488551473,0.238053579626575};
int key[15] = {1, 1, 1, -1, -1, -1, 1, -1, -1, 1, 1, -1, 1, -1, 1}; // packet header
/*
const float RRC_r[RRC_LEN] = {0.0290581511866829,0.0292861195166709,0.0287874417058172,0.0275436194555175,0.0255527588425467,0.0228302397253860,0.0194090371891105,0.0153396797427319,
                             0.0106898363592876,0.00554353211700836,-8.89649295997777e-18,-0.00582781581531654,-0.0118150822918442,-0.0178271953766885,-0.0237221565644684,
                             -0.0293531653612106,-0.0345713796105044,-0.0392287913457370,-0.0431811625587258,-0.0462909631069959,-0.0484302519778048,-0.0494834433212715,
                             -0.0493499000671152,-0.0479463005336786,-0.0452087271829673,-0.0410944315056948,-0.0355832348467026,-0.0286785316929336,-0.0204078694131854,
                             -0.0108230865141592,8.89649295997777e-18,0.0119623587788076,0.0249429515050043,0.0388003664080867,0.0533748522700539,0.0684907191761580,
                             0.0839590647683679,0.0995807780314863,0.115149766823269,0.130456350574261,0.145290755933415,0.159446650701875,0.172724650234903,0.184935730629903,
                             0.195904484459525,0.205472157528474,0.213499409080215,0.219868742979158,0.224486563545039,0.227284816797345,0.228222185737461,0.227284816797345,
                             0.224486563545039,0.219868742979158,0.213499409080215,0.205472157528474,0.195904484459525,0.184935730629903,0.172724650234903,0.159446650701875,
                             0.145290755933415,0.130456350574261,0.115149766823269,0.0995807780314863,0.0839590647683679,0.0684907191761580,0.0533748522700539,0.0388003664080867,
                             0.0249429515050043,0.0119623587788076,8.89649295997777e-18,-0.0108230865141592,-0.0204078694131854,-0.0286785316929336,-0.0355832348467026,
                             -0.0410944315056948,-0.0452087271829673,-0.0479463005336786,-0.0493499000671152,-0.0494834433212715,-0.0484302519778048,-0.0462909631069959,
                             -0.0431811625587258,-0.0392287913457370,-0.0345713796105044,-0.0293531653612106,-0.0237221565644684,-0.0178271953766885,-0.0118150822918442,
                             -0.00582781581531654,-8.89649295997777e-18,0.00554353211700836,0.0106898363592876,0.0153396797427319,0.0194090371891105,0.0228302397253860,
                             0.0255527588425467,0.0275436194555175,0.0287874417058172,0.0292861195166709,0.0290581511866829};
*/
const float RRC_r[RRC_LEN] ={0.00143800214270522,0.00144816057691194,0.00144943301783296,0.00144162808585865,0.00142460552944395,0.00139827810219715,0.00136261316794256,0.00131763401933809,0.00126342089697471,0.00120011169732556,0.00112790235944310,0.00104704692191476,0.000957857243274531,0.000860702380821793,0.000756007624610302,0.000644253185231749,0.000525972535919491,0.000401750411429899,0.000272220468110972,0.000138062611530720,-9.80681779135501e-19,-0.000141204265723135,-0.000284750754330121,-0.000429807603343269,-0.000575514690009240,-0.000720988055929329,-0.000865324565911567,-0.00100760677986483,-0.00114690801497345,-0.00128229757390351,-0.00141284611340767,-0.00153763112642319,-0.00165574250960631,-0.00176628818722360,-0.00186839976143427,-0.00196123815825416,-0.00204399923789784,-0.00211591933775631,-0.00217628071598787,-0.00222441686358391,-0.00225971765282248,-0.00228163429024256,-0.00228968404266367,-0.00228345470533815,-0.00226260878205803,-0.00222688734794361,-0.00217611356671424,-0.00211019583548131,-0.00202913053150484,-0.00193300433691368,-0.00182199611910039,-0.00169637834635802,-0.00155651802032111,-0.00140287710889851,-0.00123601246563271,-0.00105657522378007,-0.000865309655867554,-0.000663051492034711,-0.000450725693101774,-0.000229343677005577,1.27125415813861e-18,0.000236131503184065,0.000477802113197999,0.000723693144090804,0.000972421372774239,0.00122254496440190,0.00147256987532319,0.00172095671251250,0.00196612802566878,0.00220647600554568,0.00244037055952234,0.00266616773297232,0.00288221844264802,0.00308687748608236,0.00327851278893184,0.00345551485025733,0.00361630634397310,0.00375935183310101,0.00388316755205678,0.00398633121097711,0.00406749177508047,0.00412537917124664,0.00415881387340952,0.00416671631798817,0.00414811610043973,0.00410216090410665,0.00402812511285401,0.00392541805955125,0.00379359186324818,0.00363234880892571,0.00344154822496740,0.00322121281499444,0.00297153440243122,0.00269287904811554,0.00238579150343059,0.00205099896380837,0.00168941409002713,0.00130213726748985,0.000890458076615700,0.000455855950591328,-1.81607736876945e-18,-0.000475252012737543,-0.000967855562631844,-0.00147558212496436,-0.00199602281779975,-0.00252659292643060,-0.00306453730810501,-0.00360693667143030,-0.00415071472085631,-0.00469264615263941,-0.00522936548469074,-0.00575737669873733,-0.00627306366929274,-0.00677270135006130,-0.00725246768460679,-0.00770845620442020,-0.00813668927393946,-0.00853313193862610,-0.00889370632890424,-0.00921430656963562,-0.00949081414185442,-0.00971911364073362,-0.00989510887121576,-0.0100147392204277,-0.0100739962439251,-0.0100689404009891,-0.00999571787263773,-0.00985057739472294,-0.00962988703747614,-0.00933015086214252,-0.00894802538491526,-0.00848033577825067,-0.00792409173981658,-0.00727650295980157,-0.00653499411809249,-0.00569721934391214,-0.00476107607189464,-0.00372471823026165,-0.00258656869874086,-0.00134533097613538,3.26893926378500e-18,0.00145012793630173,0.00300544622080416,0.00466602996272512,0.00643162907957698,0.00830166247255769,0.0102752133271756,0.0123510255718674,0.0145275015229971,0.0168027007400960,0.0191743401105327,0.0216397951780127,0.0241961027244149,0.0268399646095021,0.0295677528680123,0.0323755160585648,0.0352589868537377,0.0382135908555865,0.0412344566158287,0.0443164268349142,0.0474540707092721,0.0506416973911910,0.0538733705210636,0.0571429237871463,0.0604439774635503,0.0637699558729307,0.0671141057162819,0.0704695152084026,0.0738291339539837,0.0771857934959063,0.0805322284642373,0.0838610982515900,0.0871650091379824,0.0904365367861051,0.0936682490259923,0.0968527288465063,0.0999825975097875,0.103050537703906,0.106049316648375,0.108971809066967,0.111811019942385,0.114560106967837,0.117212402611362,0.119761435709945,0.122200952511963,0.124524937088365,0.126727631035166,0.128803552392332,0.130747513706974,0.132554639171868,0.134220380773729,0.135740533389353,0.137111248771684,0.138329048372050,0.139390834949201,0.140293902920448,0.141035947414951,0.141615071994232,0.142029795010077,0.142279054575251,0.142362212127816,0.142279054575251,0.142029795010077,0.141615071994232,0.141035947414951,0.140293902920448,0.139390834949201,0.138329048372050,0.137111248771684,0.135740533389353,0.134220380773729,0.132554639171868,0.130747513706974,0.128803552392332,0.126727631035166,0.124524937088365,0.122200952511963,0.119761435709945,0.117212402611362,0.114560106967837,0.111811019942385,0.108971809066967,0.106049316648375,0.103050537703906,0.0999825975097875,0.0968527288465063,0.0936682490259923,0.0904365367861051,0.0871650091379824,0.0838610982515900,0.0805322284642373,0.0771857934959063,0.0738291339539837,0.0704695152084026,0.0671141057162819,0.0637699558729307,0.0604439774635503,0.0571429237871463,0.0538733705210636,0.0506416973911910,0.0474540707092721,0.0443164268349142,0.0412344566158287,0.0382135908555865,0.0352589868537377,0.0323755160585648,0.0295677528680123,0.0268399646095021,0.0241961027244149,0.0216397951780127,0.0191743401105327,0.0168027007400960,0.0145275015229971,0.0123510255718674,0.0102752133271756,0.00830166247255769,0.00643162907957698,0.00466602996272512,0.00300544622080416,0.00145012793630173,3.26893926378500e-18,-0.00134533097613538,-0.00258656869874086,-0.00372471823026165,-0.00476107607189464,-0.00569721934391214,-0.00653499411809249,-0.00727650295980157,-0.00792409173981658,-0.00848033577825067,-0.00894802538491526,-0.00933015086214252,-0.00962988703747614,-0.00985057739472294,-0.00999571787263773,-0.0100689404009891,-0.0100739962439251,-0.0100147392204277,-0.00989510887121576,-0.00971911364073362,-0.00949081414185442,-0.00921430656963562,-0.00889370632890424,-0.00853313193862610,-0.00813668927393946,-0.00770845620442020,-0.00725246768460679,-0.00677270135006130,-0.00627306366929274,-0.00575737669873733,-0.00522936548469074,-0.00469264615263941,-0.00415071472085631,-0.00360693667143030,-0.00306453730810501,-0.00252659292643060,-0.00199602281779975,-0.00147558212496436,-0.000967855562631844,-0.000475252012737543,-1.81607736876945e-18,0.000455855950591328,0.000890458076615700,0.00130213726748985,0.00168941409002713,0.00205099896380837,0.00238579150343059,0.00269287904811554,0.00297153440243122,0.00322121281499444,0.00344154822496740,0.00363234880892571,0.00379359186324818,0.00392541805955125,0.00402812511285401,0.00410216090410665,0.00414811610043973,0.00416671631798817,0.00415881387340952,0.00412537917124664,0.00406749177508047,0.00398633121097711,0.00388316755205678,0.00375935183310101,0.00361630634397310,0.00345551485025733,0.00327851278893184,0.00308687748608236,0.00288221844264802,0.00266616773297232,0.00244037055952234,0.00220647600554568,0.00196612802566878,0.00172095671251250,0.00147256987532319,0.00122254496440190,0.000972421372774239,0.000723693144090804,0.000477802113197999,0.000236131503184065,1.27125415813861e-18,-0.000229343677005577,-0.000450725693101774,-0.000663051492034711,-0.000865309655867554,-0.00105657522378007,-0.00123601246563271,-0.00140287710889851,-0.00155651802032111,-0.00169637834635802,-0.00182199611910039,-0.00193300433691368,-0.00202913053150484,-0.00211019583548131,-0.00217611356671424,-0.00222688734794361,-0.00226260878205803,-0.00228345470533815,-0.00228968404266367,-0.00228163429024256,-0.00225971765282248,-0.00222441686358391,-0.00217628071598787,-0.00211591933775631,-0.00204399923789784,-0.00196123815825416,-0.00186839976143427,-0.00176628818722360,-0.00165574250960631,-0.00153763112642319,-0.00141284611340767,-0.00128229757390351,-0.00114690801497345,-0.00100760677986483,-0.000865324565911567,-0.000720988055929329,-0.000575514690009240,-0.000429807603343269,-0.000284750754330121,-0.000141204265723135,-9.80681779135501e-19,0.000138062611530720,0.000272220468110972,0.000401750411429899,0.000525972535919491,0.000644253185231749,0.000756007624610302,0.000860702380821793,0.000957857243274531,0.00104704692191476,0.00112790235944310,0.00120011169732556,0.00126342089697471,0.00131763401933809,0.00136261316794256,0.00139827810219715,0.00142460552944395,0.00144162808585865,0.00144943301783296,0.00144816057691194,0.00143800214270522};

void normalize(const uint16_t * samples, float * norm_samples);
void costas_loop(float * samples, float * samples_d);
int  timing_recovery(float * filtered_samps, int * symbs);

/*
Takes samples and turns them into symbols.
samples: samples from ADC
symbs: symbs at the output
params: parameters that need to be stored intermediately
returns length of symbs array. symbs array must be 
allocated for longer than samples/sps + some margin
*/

int demodulate(const uint16_t * samples, int * symbs, params_r * params) {
    float norm_samples[NUM_SAMPLES];
    normalize(samples, norm_samples);

    if (DEBUG) {
        FILE *fpt1 = fopen("norm_wave.csv", "w+");
        for (int i = 0; i < NUM_SAMPLES; i++) {
            fprintf(fpt1, "%f,", norm_samples[i]);
        }
        fclose(fpt1);
    }

    float samples_d[NUM_SAMPLES] = {0, 0, 0, 0, 0, 0};
    float phase = 0;
    float inph[ORDER+1] = {0, 0, 0, 0, 0, 0};
    float quad[ORDER+1] = {0, 0, 0, 0, 0, 0};
    float inph_[ORDER+1] = {0, 0, 0, 0, 0, 0};
    float quad_[ORDER+1] = {0, 0, 0, 0, 0, 0};
    double error = 0;
    double integrator = 0;

    float kp = 8.5;
    float ki = 0.1;
    float dt = FC/FS;

    for (int i = ORDER; i < NUM_SAMPLES+ORDER; i++) {
        // define t from microcontroller
        int k = i - ORDER;
        inph_[ORDER] = norm_samples[k]*2*cos(2*M_PI*dt*k + phase);
        quad_[ORDER] = norm_samples[k]*-2*sin(2*M_PI*dt*k + phase);

        filter(inph_,lp, inph, ORDER+1,ORDER+1);
        filter(quad_,lp, quad, ORDER+1,ORDER+1);

        samples_d[k] = inph[ORDER];

        error = inph[ORDER] * quad[ORDER];
        integrator = integrator + ki*error;
        phase = phase + kp*error + integrator;
        
        // shift the values of inph_ and quad_
        for (int j = 1; j < ORDER+1; j++) {
            inph_[j-1] = inph_[j];
            quad_[j-1] = quad_[j];
        }
    }

    if (DEBUG) {
        FILE *fpt3 = fopen("costa_samples.csv", "w+");
        for (int i = 0; i < NUM_SAMPLES; i++) {
            fprintf(fpt3, "%f,", samples_d[i]);
        }
        fclose(fpt3);
    }
    
    // filter w SRRC
    float filtered_samps[1<<((int)ceil(log2(NUM_SAMPLES)))];
    conv(samples_d, RRC_r, filtered_samps, NUM_SAMPLES, RRC_LEN);
    // readjust window
    float shift = RRC_LEN/2. - 0.5;
    int k;
    for (int i = shift ; i < NUM_SAMPLES+RRC_LEN-1-shift; i++) {
        k = i - shift;
        filtered_samps[k] = filtered_samps[i];
    }

    if(DEBUG) {
        FILE *fpt2 = fopen("SRRC.csv", "w+");
        for (int i = 0; i < NUM_SAMPLES; i++) {
            fprintf(fpt2, "%f,", filtered_samps[i]);
        }
        fclose(fpt2);
    }

    // timing recovery
    const float kp_PLL = 0.01;
    const float ki_PLL = 0.05;
    const float margin = 0.75;

    float sps = params->sps;
    integrator = 0; error = 0;
    float prev_phase = params->TR_phase;
    int bit_len = 0;
    
    float zc[NUM_SAMPLES-1];

    // calculate zero crossings
    for (int i = 0; i < NUM_SAMPLES-1; i++) {
        int temp = (filtered_samps[i+1] * filtered_samps[i])/abs((filtered_samps[i+1] * filtered_samps[i]));
        zc[i] = !(temp+1);
    }

    // timing recovery
    for (int i = 1; i < NUM_SAMPLES; i++) {
        phase = prev_phase + 2*M_PI/sps;
        phase = wrap_to_pi(phase);
        if (phase < -M_PI * margin && prev_phase > M_PI * margin) {
            symbs[bit_len] = (int)(filtered_samps[i]/fabs(filtered_samps[i]));
            bit_len++;
        }
        if (bit_len==N) {
            break;
        }
        if (zc[i-1]){
            error = phase;
            integrator = integrator + error * ki_PLL;
            sps = SPS + error*kp_PLL + integrator;
        }
        prev_phase = phase;
    }

    if(DEBUG) {
        FILE *fpt4 = fopen("sampled.csv", "w+");
        for (int i = 0; i < N; i++) {
            fprintf(fpt4, "%i,", symbs[i]);
        }
        fclose(fpt4);
    }

    return bit_len;
}


void find_packet(int * symbs, uint8_t * out, const int num_symbs) {
    // take cross correlation
    int xcorr_out[CORRELATION_BUFFER];
    xcorr(symbs, key, xcorr_out, num_symbs, 15);

    // find packet
    int shift = 0;
    for (int i = 0; i < num_symbs-30; i++) {
        if (abs(xcorr_out[i] + xcorr_out[i+15] + xcorr_out[i+30] ) > 39) {
            shift = i+45;
            if (xcorr_out[i] < 0) {
                for (int i = 0; i < N; i++) {
                    symbs[shift + i] = symbs[shift+ i]*-1;
                }
            }
            break;
        }
    }
    
    // convert symbols to bits
    for (int i = 0; i < N; i++) {
        out[i] = (symbs[shift+i]+1)*0.5;
    }
}

void normalize(const uint16_t * samples, float * norm_samples) {
        // Normalize signal
    float var = 0, mean = 0;
    // find mean
    for (int i = 0; i < NUM_SAMPLES; i++) {
        mean += samples[i];
    }
    mean /= NUM_SAMPLES;
    // find sample variance
    for (int i = 0; i < NUM_SAMPLES; i++) {
        float temp = samples[i]-mean;
        var += temp * temp;
    }
    var /= NUM_SAMPLES-1;

    // normalize
    // divide by 60 arbitrary, just done to get to an ampltiude I used to tune gain values
    for (int i = 0; i < NUM_SAMPLES; i++) {
        norm_samples[i] = (samples[i]-mean)/var*3;
    }
}